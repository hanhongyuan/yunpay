package com.yunpay.serv.service.impl;

import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.yunpay.common.utils.EnumUtil.PayChannel;
import com.yunpay.common.utils.EnumUtil.PayStatus;
import com.yunpay.common.utils.EnumUtil.SubChannel;
import com.yunpay.common.utils.EnumUtil.TransType;
import com.yunpay.common.utils.IdWorker;
import com.yunpay.serv.dao.PayTranLsDao;
import com.yunpay.serv.model.Merchant;
import com.yunpay.serv.model.PayTranLs;
import com.yunpay.serv.req.QrPayReqDto;
import com.yunpay.serv.service.PayTranLsService;

/**
 * 交易流水业务类
 * 文件名称:     PayTranLsServiceImpl.java
 * 内容摘要: 
 * @author:   Zeng Dongcheng
 * @version:  1.0  
 * @Date:     2017年6月22日下午1:37:27 
 * 
 * 修改历史:  
 * 修改日期                     修改人员                                   版本	            修改内容  
 * ----------------------------------------------  
 * 2017年6月22日     Zeng Dongcheng   1.0     新建
 *
 * 版权:   版权所有(C)2017
 * 公司:   深圳市至高通信技术发展有限公司
 */
@Service
public class PayTranLsServiceImpl implements PayTranLsService{
	
	@Autowired
	private PayTranLsDao payTranLsDao;

	/**
	 * 创建微信交易流水
	 * @Description:
	 * @author:   Zeng Dongcheng
	 * @Date:     2017年6月21日下午6:07:01 
	 * @param qrPayReq
	 * @param merchant
	 * @param subChannel
	 * @return
	 */
	@Override
	public PayTranLs createWechatTranLs(QrPayReqDto qrPayReq, Merchant merchant,
			SubChannel subChannel) {
		// TODO Auto-generated method stub
		IdWorker iw = new IdWorker();
		PayTranLs payTranLs = new PayTranLs();
		String orderNo = iw.getId() + "";
		payTranLs.setChannel(PayChannel.WECHAT.getValue());
		if(subChannel == SubChannel.WACHAT_BAR){
			//微信条码支付
			payTranLs.setSubChannel(SubChannel.WACHAT_BAR.getValue());
			payTranLs.setTitle(SubChannel.WACHAT_BAR.getName());
			payTranLs.setInfo(SubChannel.WACHAT_BAR.getName());
			payTranLs.setStatus(PayStatus.PAYING.getValue());
		}else if(subChannel == SubChannel.WACHT_WAP){
			//微信Wap支付
			payTranLs.setSubChannel(SubChannel.WACHT_WAP.getValue());
			payTranLs.setTitle(SubChannel.WACHT_WAP.getName());
			payTranLs.setInfo(SubChannel.WACHT_WAP.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());
		}else{
			//微信扫码支付
			payTranLs.setSubChannel(SubChannel.WACHAT_SCAN.getValue());
			payTranLs.setTitle(SubChannel.WACHAT_SCAN.getName());
			payTranLs.setInfo(SubChannel.WACHAT_SCAN.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());
		}
		payTranLs.setMerchantName(merchant.getCompanyName());
		payTranLs.setSerialNo(merchant.getMerchantNo());
		payTranLs.setAgentSerialNo(merchant.getAgentSerialNo());
		payTranLs.setTerminalNum(qrPayReq.getTerminal_unique_no());
		payTranLs.setTransNum(orderNo);
		payTranLs.setTransTime(new Date());
		payTranLs.setTotalPrice(Float.valueOf(qrPayReq.getTotal_fee()));//订单金额
		payTranLs.setTransPrice(Float.valueOf(qrPayReq.getTotal_fee()));//实际支付金额
		payTranLs.setTransType(TransType.PAY.getValue()); // 交易类型，0:支付，1:退款
		payTranLs.setUser_order_no(qrPayReq.getUser_order_no());
		payTranLs.setSubject(qrPayReq.getBody());
		payTranLs.setMerchantNo(merchant.getMerchantNo());
		payTranLs.setOrgNo(merchant.getOrgNo());
		payTranLs.setAttach(qrPayReq.getAttach());
		payTranLsDao.insert(payTranLs);
		return payTranLs;
	}
	
	/**
	 * @Description:创建支付宝交易流水
	 * @author:   Zeng Dongcheng
	 * @Date:     2017年6月23日下午5:00:54 
	 * @param qrPayReq
	 * @param merchant
	 * @param subChannel
	 * @return
	 */
	@Override
	public PayTranLs createAlipayTranLs(QrPayReqDto qrPayReq,
			Merchant merchant, SubChannel subChannel) {
		// TODO Auto-generated method stub
		IdWorker iw = new IdWorker();
		PayTranLs payTranLs = new PayTranLs();
		//生成流水号
		String orderNo = iw.getId() + "";
		payTranLs.setTransNum(orderNo);
		payTranLs.setChannel(PayChannel.ALIPAY.getValue());
		if(subChannel==SubChannel.ALIPAY_BAR){
			//支付宝条码支付
			payTranLs.setSubChannel(SubChannel.ALIPAY_BAR.getValue());
			payTranLs.setTitle(SubChannel.ALIPAY_BAR.getName());
			payTranLs.setInfo(SubChannel.ALIPAY_BAR.getName());
			payTranLs.setStatus(PayStatus.PAYING.getValue());  
		}else if(subChannel==SubChannel.ALIPAY_WAP){
			//支付宝wap支付
			payTranLs.setSubChannel(SubChannel.ALIPAY_WAP.getValue());
			payTranLs.setTitle(SubChannel.ALIPAY_WAP.getName());
			payTranLs.setInfo(SubChannel.ALIPAY_WAP.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());  
		}else{
			//支付宝扫码支付
			payTranLs.setSubChannel(SubChannel.ALIPAY_SCAN.getValue());
			payTranLs.setTitle(SubChannel.ALIPAY_SCAN.getName());
			payTranLs.setInfo(SubChannel.ALIPAY_SCAN.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());  
		}
		payTranLs.setMerchantName(merchant.getCompanyName());
		payTranLs.setSerialNo(merchant.getMerchantNo());
		payTranLs.setTerminalNum(qrPayReq.getTerminal_unique_no());
		//取消，未发现实际用处
		//sysTransaction.setTransCardNum(sysAlipayConfig.getSellerEmail());
		payTranLs.setTransTime(new Date());
		payTranLs.setTransPrice(Float.valueOf(qrPayReq.getTotal_fee()));	
		payTranLs.setTotalPrice(Float.valueOf(qrPayReq.getTotal_fee()));
		
		payTranLs.setTransType(TransType.PAY.getValue());	//交易类型，0:支付，1:退款
		payTranLs.setUser_order_no(qrPayReq.getUser_order_no());
		payTranLs.setSubject(qrPayReq.getBody());
		payTranLs.setAgentSerialNo(merchant.getAgentSerialNo());
		payTranLs.setMerchantNo(qrPayReq.getMerchant_num());	
		payTranLs.setOrgNo(merchant.getOrgNo());
		payTranLsDao.insert(payTranLs);
		return payTranLs;
	}
	
	/**
	 * @Description:创建银联交易流水
	 * @author:   Zeng Dongcheng
	 * @Date:     2017年7月6日上午11:25:37 
	 * @param qrPayReq
	 * @param merchant
	 * @param subChannel
	 * @return
	 */
	@Override
	public PayTranLs createUnionTranLs(QrPayReqDto qrPayReq, Merchant merchant,
			SubChannel subChannel) {
		// TODO Auto-generated method stub
		IdWorker iw = new IdWorker();
		PayTranLs payTranLs = new PayTranLs();
		String orderNo = iw.getId() + "";
		payTranLs.setChannel(PayChannel.UNION.getValue());
		if(subChannel == SubChannel.UNION_BAR){
			//微信条码支付
			payTranLs.setSubChannel(SubChannel.UNION_BAR.getValue());
			payTranLs.setTitle(SubChannel.UNION_BAR.getName());
			payTranLs.setInfo(SubChannel.UNION_BAR.getName());
			payTranLs.setStatus(PayStatus.PAYING.getValue());
		}else if(subChannel == SubChannel.UNION_WAP){
			//微信Wap支付
			payTranLs.setSubChannel(SubChannel.UNION_WAP.getValue());
			payTranLs.setTitle(SubChannel.UNION_WAP.getName());
			payTranLs.setInfo(SubChannel.UNION_WAP.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());
		}else{
			//微信扫码支付
			payTranLs.setSubChannel(SubChannel.UNION_SCAN.getValue());
			payTranLs.setTitle(SubChannel.UNION_SCAN.getName());
			payTranLs.setInfo(SubChannel.UNION_SCAN.getName());
			payTranLs.setStatus(PayStatus.UNPAY.getValue());
		}
		payTranLs.setMerchantName(merchant.getCompanyName());
		payTranLs.setSerialNo(merchant.getMerchantNo());
		payTranLs.setAgentSerialNo(merchant.getAgentSerialNo());
		payTranLs.setTerminalNum(qrPayReq.getTerminal_unique_no());
		payTranLs.setTransNum(orderNo);
		payTranLs.setTransTime(new Date());
		payTranLs.setTotalPrice(Float.valueOf(qrPayReq.getTotal_fee()));//订单金额
		payTranLs.setTransPrice(Float.valueOf(qrPayReq.getTotal_fee()));//实际支付金额
		payTranLs.setTransType(TransType.PAY.getValue()); // 交易类型，0:支付，1:退款
		payTranLs.setUser_order_no(qrPayReq.getUser_order_no());
		payTranLs.setSubject(qrPayReq.getBody());
		payTranLs.setMerchantNo(merchant.getMerchantNo());
		payTranLs.setOrgNo(merchant.getOrgNo());
		payTranLs.setAttach(qrPayReq.getAttach());
		payTranLsDao.insert(payTranLs);
		return payTranLs;
	}

	/**
	 * @Description:修改交易流水
	 * @author:   	Zeng Dongcheng
	 * @Date:       2017年6月22日下午1:37:49 
	 * @param payTranLs
	 * @return
	 */
	@Override
	public PayTranLs updatePayTranLs(PayTranLs payTranLs) {
		// TODO Auto-generated method stub
		payTranLsDao.updateByPrimaryKeySelective(payTranLs);
		return payTranLs;
	}


	@Override
	public PayTranLs findTranLsByOrderNo(String userOrderNo, String merchantNo) {
		// TODO Auto-generated method stub
		return payTranLsDao.findTranLsByOrderNo(userOrderNo, merchantNo);
	}
	
	@Override
	public PayTranLs findTranLsByTransNum(String transNum) {
		// TODO Auto-generated method stub
		return payTranLsDao.findTranLsByTransNum(transNum);
	}

	@Override
	public int updTranStatus(int id, int status) {
		// TODO Auto-generated method stub
		return payTranLsDao.updTranStatus(id, status);
	}

	@Override
	public List<PayTranLs> selectAllSynPayLs(Integer intervalTime) {
		// TODO Auto-generated method stub
		return payTranLsDao.selectAllSynPayLs(intervalTime);
	}


}
